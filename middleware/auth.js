: const jwt = require('jsonwebtoken'); const User = require('../models/User'); module.exports = async function (req, res, next) { const auth = req.headers.authorization; if (!auth) return res.status(401).json({ error: 'No token' }); const token = auth.replace('Bearer ', ''); try { const payload = jwt.verify(token, process.env.JWT_SECRET || 'dev'); req.user = await User.findById(payload.id).select('-password'); next(); } catch (err) { return res.status(401).json({ error: 'Invalid token' }); } };
middleware/errorHandler.js: module.exports = (err, req, res, next) => { console.error(err.stack); const statusCode = res.statusCode === 200 ? 500 : res.statusCode; res.status(statusCode).json({ message: err.message || 'An unexpected error occurred.', stack: process.env.NODE_ENV === 'production' ? null : err.stack, }); };